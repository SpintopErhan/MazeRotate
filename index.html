<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | Maze Rotator</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <style>
      html, body { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
      
      #unity-container { 
        position: fixed; inset: 0; width: 100%; height: 100%; 
        background: radial-gradient(circle, #2a2a2a 0%, #000000 100%); 
      }
      
      #unity-canvas { width: 100% !important; height: 100% !important; display: block; object-fit: contain; }

      /* --- KARADAGGAMES PREMIUM LOADING --- */
      #custom-loading-screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        /* Arka Plan: KaradagGames logonu Ã¶ne Ã§Ä±karan merkezi aydÄ±nlatma */
        background: radial-gradient(circle at center, #3a3a3a 0%, #1a1a1a 40%, #000000 100%);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        z-index: 99; transition: opacity 0.8s ease;
      }

      #custom-logo {
        width: 220px; 
        height: auto;
        margin-bottom: 40px;
        filter: drop-shadow(0 0 15px rgba(255,255,255,0.15));
      }

      #custom-loader-bar {
        width: 250px; height: 3px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px; overflow: hidden;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
      }

      #custom-loader-fill {
        width: 0%; height: 100%;
        /* GÃ¼mÃ¼ÅŸ/Metalik geÃ§iÅŸ efekti */
        background: linear-gradient(90deg, #666 0%, #dcdcdc 50%, #666 100%);
        background-size: 200% 100%;
        animation: shine 2s linear infinite;
        transition: width 0.3s ease-out;
      }

      @keyframes shine {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
      }

      #progress-percent {
        color: #cecece; font-size: 16px; font-weight: 300;
        margin-top: 15px; letter-spacing: 2px;
        font-family: 'Verdana', sans-serif;
      }

      #loading-text { color: #666; margin-top: 5px; font-size: 10px; letter-spacing: 4px; text-transform: uppercase; }
    </style>

    <meta property="fc:frame" content='{"version": "next","imageUrl": "https://maze-rotate.vercel.app/preview.png","button": {"title": "Maze Rotator Oyna","action": {"type": "launch_miniapp","name": "Maze Rotator","url": "https://maze-rotate.vercel.app"}}}' />
  </head>
  <body>
    
    <div id="unity-container">
      <canvas id="unity-canvas" tabindex="-1"></canvas>
      
      <div id="custom-loading-screen">
        <img src="TemplateData/KaradagGamesLogo.png" id="custom-logo" alt="KaradagGames"> 
        <div id="custom-loader-bar">
          <div id="custom-loader-fill"></div>
        </div>
        <div id="progress-percent">0%</div>
        <div id="loading-text">LOADING...</div>
      </div>

      <div id="unity-warning"></div>
    </div>

    <script>
      var container = document.querySelector("#unity-container");
      var canvas = document.querySelector("#unity-canvas");
      var loadingScreen = document.querySelector("#custom-loading-screen");
      var loadingBarFill = document.querySelector("#custom-loader-fill");
      var percentText = document.querySelector("#progress-percent");

      var buildUrl = "Build";
      var loaderUrl = buildUrl + "/Builds.loader.js";
      var config = {
        dataUrl: buildUrl + "/Builds.data.unityweb",
        frameworkUrl: buildUrl + "/Builds.framework.js.unityweb",
        codeUrl: buildUrl + "/Builds.wasm.unityweb",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "KaradagGames",
        productName: "Maze Rotator",
        productVersion: "0.1",
      };

      var script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          var percentValue = Math.round(progress * 100);
          loadingBarFill.style.width = percentValue + "%";
          percentText.innerHTML = percentValue + "%";
        }).then((unityInstance) => {
          window.unityInstance = unityInstance;
          loadingScreen.style.opacity = "0";
          setTimeout(() => { loadingScreen.style.display = "none"; }, 800);
        }).catch((message) => { alert(message); });
      };
      document.body.appendChild(script);
    </script>

    <script type="module">
      import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk@0.2.2'

      async function waitForUnityInstance(timeout = 60000) {
        return new Promise((resolve, reject) => {
          const start = Date.now();
          const interval = setInterval(() => {
            if (window.unityInstance) {
              clearInterval(interval);
              resolve(window.unityInstance);
            }
            if (Date.now() - start > timeout) {
              clearInterval(interval);
              reject(new Error("Unity instance timeout"));
            }
          }, 200);
        });
      }

      window.farcasterDataString = ""; 

      (async () => {
        try {
          await sdk.actions.ready({ disableNativeGestures: true });
          const context = await sdk.context;
          const user = context?.user || {};
          
          const userData = {
            fid: user.fid,
            username: user.username,
            displayName: user.displayName,
            pfpUrl: user.pfp?.url || user.pfpUrl || ""
          };
          window.farcasterDataString = JSON.stringify(userData);

          const unityInstance = await waitForUnityInstance();
          
          if (user.fid > 0 && user.username) {
            unityInstance.SendMessage('GameManager', 'SetFarcasterUser', window.farcasterDataString);
          }
        } catch (err) {
          console.error("[FarcasterSDK] Error:", err);
        }

        // Sabit link ile Cast atma fonksiyonu
        window.openCastComposer = function(customText = "") {
          sdk.actions.composeCast({
            text: customText || "Maze Rotator'da zirveye oynuyorum! ðŸ”ï¸ #MazeRotator",
            embeds: ["https://maze-rotate.vercel.app"] 
          }).catch(err => console.error("ComposeCast error:", err));
        };
      })();
    </script>
  </body>
</html>
